\documentclass[10pt]{article}

\title{Mozilla Addon Builder\\ Definition of the Package Building System}
\author{Piotr Zalewa}
\date{\today}

\def\Ua{{\tt Ua}}
\def\Ub{{\tt Ub}}
\def\La{{\tt La}}
\def\Ma{{\tt Ma}}
\def\Mb{{\tt Mb}}

\def\xpi{{\tt XPI}}

\def\headsto{${\Longrightarrow}$ }
\def\hto{\headsto}
\def\eq{${\supset}$ }

\usepackage{fullpage, url}
\begin{document}
\maketitle

\noindent\hfill{\small \em This document is written in \LaTeX\ \footnote{For quick doc please follow to \url{http://web.mit.edu/olh/Latex/ess:Latex.html}, All used symbols may be found here: \url{http://www.artofproblemsolving.com/Wiki/index.php/LaTeX:Symbols}}}

\noindent If in doubts, please take a look at the accompanied document:\\ {\tt http://github.com/zalun/FlightDeck/raw/master/Docs/Addon\%20Builder\%20-\%20Build\%20System.pdf}.

\section{Syntax}

	\subsection{Objects}
	
	{\em \small {\tt x}, {\tt y}, {\tt z} --- represents {\tt [a..z]}\\
	{\tt m}, {\tt n} --- represents {\tt [0..9]+}}
	
	\begin{description}
		\item[{\tt Ux}] is the specific User (identified by {\em User:name})
		\item[{\tt Px}] is the specific Package (identified by {\em Package:name})\\
			It should always be used within its {\tt type} context as {\tt Lx} --- Library or {\tt Ax} --- Addon\\
			Every Package has an associated PackageRevision\footnote{PackageRevision is not the same as Package version. The latter is just meta-data, a text field of PackageRevision object used only in exported \xpi. It will no longer be used for data identification.} (identified by a triplet {\tt Ux:Py.n} {\em User/Package/PackageRevision:revisionNumber})
		\item[{\tt Mx}] is the Module (identified by {\tt Ux:Py.n:Mz} {\em PackageRevision/Module:name}\footnote{Every data object is identified by a PackageRevision. The concept is similar to {\em git}'s commits. In essence, for every saved Module change, a new PackageRevision is created.})
	\end{description}

	\subsection{Object identification --- revision numbers and HEAD}
	\begin{description}
		\item[{\tt Ux:Py.n}] defines revision of the Package.\\ 
			{\tt Ua:La.1} --- First revision of Library \La\ saved by \Ua.
		\item[{\tt Ux:Py.n:Mz}] defines the precise Module revision --- a Module inside the PackageRevision. \\ 
			{\tt Ua:La.1:Ma} --- Module \Ma\ inside the first revision of Library \La\ saved by \Ua.
		\item[{\tt Px \hto  Uy:Px.n}] is the HEAD revision of the Package\\ 
			{\tt La \hto  Ua:La.1} --- \La's HEAD points to the first revision of Library \La\ saved by \Ua.
		\item[{\tt Ux:Py.n \eq \{Ux:Py.m:Mz, \ldots\}}] Modules inside the Package revision.\\ 
			{\tt Ua:La.2 \eq \{Ua:La.1:Ma, Ub:La.2:Mb\}} --- Second revision of Library \La\ saved by \Ua\ contains \Ma\ saved by \Ua\ in his \La's first revision and \Mb\ saved by \Ub\ in his second \La's revision.
	\end{description}

\section{Editing Library and its Modules}

	\subsection{Starting point}

		\subsubsection*{{\tt La \hto  Ua:La.1 \eq \{Ua:La.1:Ma\}}}
			Package \La\ is created by User \Ua.\\
			\La's HEAD is PackageRevision identified as {\tt Ua:La.1}\\
			It contains only one module - \Ma
			
			\noindent Following steps had to happen to achieve above status:
			\begin{enumerate}
				\item{\Ua\ creates a package \La\\
				    {\tt La \hto  Ua:La.0} \\
				    {\tt Ua:La.0 \eq \{\}}
				}
				\item{\Ua\ adds \Ma\ to \La\\
					{\tt Ua:La.1 \eq \{Ua:La.1:Ma\}}
				}
				\item{\Ua\ sets the HEAD\\
					{\tt La \hto  Ua:La.1}
				}
			\end{enumerate}
			
	\subsection{Scenario (1 Module, 2 Users, no dependencies)}
		\Ua\ and \Ub\ are working on \La\\
		\Ub\ modified one module

		\begin{enumerate}
			\item{\Ub\ modifies \Ma\\
            		{\tt Ub:La.0 \eq \{Ua:La.1:Ma\}} --- automatic fork of \La\\
				{\tt Ub:La.1 \eq \{Ub:La.1:Ma\}}
			}
			\item{\Ub\ sends {\em request} to \La's creator (\Ua) to upgrade \La\ from {\tt Ub:La.1}}
			\item{\Ua\ accepts the request by setting the HEAD to \Ub's version\\
				{\tt La \hto  Ub:La.1}
			}
			\item{Result: {\tt La \hto  Ub:La.1 \eq \{Ub:La.1:Ma\}}}
		\end{enumerate}

	\subsection{Scenario (2 Modules, 2 Users, no dependencies)}

		\Ua\ and \Ub\ are working on \La\\ 
		\Ua\ created module \Mb\\
		\Ub\ is working on \Mb\
		
		\begin{enumerate}
			\item{\Ua\ adds a new module \Mb\ to \La\\
				{\tt Ua:La.2 \eq \{Ua:La.1:Ma, Ua:La.2:Mb\}}
			}
			\item{\Ua\ sets the HEAD\\
				{\tt La \hto Ua:La.2}
			}
			\item{\Ub\ modifies \Mb\\				
				{\tt Ub:La.0 \eq \{Ua:La.1:Ma, Ua:La.2:Mb\}} --- automatic fork of \La\\
				{\tt Ub:La.1 \eq \{Ua:La.1:Ma, Ub:La.1:Mb\}}
			}
			\item{\Ub\ sends request to \Ua\ to upgrade \La\ from {\tt Ub:La.1}}
			\item{\Ua\ modifies \Ma\\
				{\tt Ua:La.3 \eq \{Ua:La.3:Ma, Ua:La.2:Mb\}}
			}
			\item{\Ua\ acepts \Ub's request\\
				{\tt Ua:La.4 \eq \{Ua:La.3:Ma, Ub:La.1:Mb\}}
			}
			\item{\Ua\ sets the HEAD\\
				{\tt La \hto Ua:La.4}
			}
			\item{Result: {\tt La -> Ua:La.4 \eq \{Ua:La.3:Ma, Ub:La.1:Mb\}}}
		\end{enumerate}

	\subsection{Scenario (2 Modules, 2 Users, no dependencies)}
	
		\Ua\ and \Ub\ are working on \La\\ 
		\Ub\ created module \Mb\
		
		\begin{enumerate}
			\item{\Ub\ adds a new module \Mb\ to \La\\
				{\tt Ub:La.0 \eq \{Ua:La.1:Ma\}} --- automatic fork of \La\\
				{\tt Ub:La.1 \eq \{Ua:La.1:Ma, Ua:La.1:Mb\}}
			}
			\item{\Ub\ modifies \Mb\\
				{\tt Ub:La.2 \eq \{Ua:La.1:Ma, Ub:La.2:Mb\}}
			}
			\item{\Ub\ sends request to \Ua\ to upgrade \La\ from {\tt Ub:La.2}}
			\item{\Ua\ modifies \Ma\\
				{\tt Ua:La.2 \eq \{Ua:La.2:Ma\}}
			}
			\item{\Ua\ acepts \Ub's request\\
				{\tt Ua:La.3 \eq \{Ua:La.2:Ma, Ub:La.2:Mb\}}
			}
			\item{\Ua\ sets the HEAD\\
				{\tt La \hto Ua:La.3}
			}
			\item{Result: {\tt La \hto Ua:La.3 \eq \{Ua:La.2:Ma, Ub:La.2:Mb\}}}
		\end{enumerate}

	\subsection{Scenario with conflict (2 Modules, 2 Users, no dependencies)}

		\Ua\ and \Ub\ are working on \La\\ 
		\Ua\ created module \Mb\\
		\Ua\ and \Ub\ are working on \Mb\\
		Conflict arises...

		\begin{enumerate}
			\item{\Ua\ adds a new module \Mb\ to \La\\
            		{\tt Ua:La.2 \eq \{Ua:La.1:Ma, Ua:La.2:Mb\}}
			}
			\item{\Ua\ sets the HEAD\\
				{\tt La \hto Ua:La.2}
			}
			\item{\Ub\ modifies \Mb\\
				{\tt Ub:La.0 \eq \{Ua:La.1:Ma, Ua:La.2:Mb\}} --- automatic fork of \La\\
				{\tt Ub:La.1 \eq \{Ua:La.1:Ma, Ub:La.1:Mb\}}
			}
			\item{\Ua\ modifies \Mb\\
				{\tt Ua:La.3 \eq \{Ua:La.1:Ma, Ua:La.2:Mb\}}
			}
			\item{{\bf CONFLICT}\\
            		At the time we've got two versions of La.Mb which came out from the same version
            	}
            	\item{\Ua\ sets the HEAD\\
            		{\tt La \eq Ua:La.3}
            	}
            	\item{\Ub\ receives info that his source is behind the HEAD\\
				{\tt Ub:La.1:Mb} (and {\tt Ub:La.1}) is marked as {\em conflicted}\\
				\Ub\ can't send the update request
			}
			\item{\Ub\ manually solves conflict by editing the \Mb\ and removing the {\em conflict flag}\\
				{\tt Ub:La.2 \eq \{Ua:La.1, Ub:La.2:Mb\}}
			}
			\item{\Ub\ sends request to \Ua\ to upgrade \La\ from {\tt Ub:La.2}}
			\item{\Ua\ acepts \Ub's request\\
				{\tt Ua:La.4 \eq \{Ua:La.3:Ma, Ub:La.2:Mb\}}
			}
			\item{\Ua\ sets the HEAD\\
				{\tt La \hto Ua:La.4}
			}
			\item{Result: {\tt La \hto Ua:La.4 \eq \{Ua:La.3:Ma, Ub:La.2:Mb\}}}
		\end{enumerate}
		
	\subsection*{Draft/Ideas}
	\begin{description}
		\item[update Library] if Library HEAD has been changed something should tell the User that an update is possible. It should then (on request) change the versions of all Modules which are not in conflict with updating Library. In essence, if \\
			{\tt Ua:La.1 \eq \{Ua:La.1:Ma, Ub:La.2:Mb\}} is a Library to be updated and \\
			{\tt La \hto Uc:La.3 \eq \{Ub:La.1:Ma, Uc:La.3:Mb, Uc:La.1:Mc\}} is current HEAD, then\\
			{\tt Ub:La.2:Mb} should be updated to {\tt Uc:La.3:Mb} and {\tt Uc:La.1:Mc} should be added.\\
			User should receive a notification that {\tt Ua:La.1:Ma} is not in sync with HEAD.
		\item[forking] Consider forcing users to create their copy of a Package before entering to edit mode (as in {\em github}), find a better name if needed ...
		\item[revision graphs] should be created inside this documentation. \\
			Consider using tikz \url{http://www.texample.net/tikz/examples/}
	\end{description}

	\subsection*{To be continued\ldots}
\end{document}
